name: CI
on:
  push:
    branches:
      # Feature branches
      - feat-*

###############################################
# REQUIRED secrets
# DOCKER_UN: ${{ secrets.Docker_Login }}
#    Username of docker login for pushing the images to repo $DOCKER_ORG
# DOCKER_PW: ${{ secrets.Docker_Password }}
#    Password of docker login for pushing the images to repo $DOCKER_ORG
# DOCKER_ORG: ${{ secrets.DOCKER_ORG }}
#    The docker repository where the images are pushed to.
################################################

env:
  MAILU_VERSION: master
  MAILU_PLATFORMS: linux/amd64,linux/arm/v7,linux/arm64

jobs:
  build:
    name: Build Mailu images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        include:
          # Helper
          - image: setup
            context: ./setup
          - image: docs
            context: ./docs
          # Core
          - image: admin
            context: ./core/admin
          - image: dovecot
            context: ./core/dovecot
          - image: nginx
            context: ./core/nginx
          - image: none
            context: ./core/none
          - image: postfix
            context: ./core/postfix
          - image: rspamd
            context: ./core/rspamd
          # Webmail
          - image: rainloop
            context: ./webmails/rainloop
          - image: roundcube
            context: ./webmails/roundcube
          # Optional
          - image: clamav
            context: ./optional/clamav
          - image: fetchmail
            context: ./optional/fetchmail
          - image: postgresql
            context: ./optional/postgresql
          - image: radicale
            context: ./optional/radicale
          - image: traefik-certdumper
            context: ./optional/traefik-certdumper
          - image: unbound
            context: ./optional/unbound
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.Docker_Login }}
          password: ${{ secrets.Docker_Password }}

      - name: Build images
        uses: docker/build-push-action@v2
        with:
          context: ./${{ matrix.context }}
          platforms: ${{ env.MAILU_PLATFORMS }}
          push: true
          tags: ${{ secrets.DOCKER_ORG }}/${{ secrets.DOCKER_PREFIX }}${{ matrix.image }}:${{ env.MAILU_VERSION }}

  test:
    name: Test Mailu images
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
      - build
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        include:
          - test_type: core
            test_start_delay: 2
          - test_type: fetchmail
            test_start_delay: 2
          - test_type: filters
            test_start_delay: 3
          - test_type: rainloop
            test_start_delay: 2
          - test_type: roundcube
            test_start_delay: 2
          - test_type: webdav
            test_start_delay: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Run test suite
        run: |
          echo "Install Python packages"
          python3 -m pip install -r tests/requirements.txt
          echo "Copy certs"
          sudo -- sh -c 'mkdir -p /mailu && cp -r tests/certs /mailu && chmod 600 /mailu/certs/*'
          echo "Run tests"
          python tests/compose/test.py ${{ matrix.test_type }} ${{ matrix.test_start_delay }}
        env:
          DOCKER_ORG: ${{ secrets.DOCKER_ORG }}
          DOCKER_PREFIX: ${{ secrets.DOCKER_PREFIX }}
          MAILU_VERSION: ${{ env.MAILU_VERSION }}
